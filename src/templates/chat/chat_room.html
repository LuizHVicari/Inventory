{% extends "_base.html" %}


{% block content %}

<div class="flex flex-col justify-center overflow-auto h-[calc(100vh-60px)] w-[calc(100vw/2)]">
  <div class="flex flex-col bg-slate-950 p-8 rounded-3xl">
    <div id="chat-log" cols="100" rows="20" readonly  disabled
      class="h-96 px-4 py-2 mb-6 resize-none border border-slate-900 rounded-3xl bg-slate-800 focus:border-slate-900 text-slate-400 overflow-y-scroll overflow-x-clip break-words"> 
      {% for message in chat_messages %}
      <span class="text-emerald-400"> {{message.sender}}: </span>{{ message.message }} <br>


      {% endfor %}
    </div>
    <input id="chat-message-input" type="text" size="100" placeholder="Digite aqui" 
    class="px-2 py-4 mb-4 bg-slate-800 rounded-lg text-slate-400">
    <div class="flex justify-center">
      <input id="chat-message-submit" type="button" value="Send" maxlength="200"
      class="bg-emerald-900 text-emerald-500 py-3 px-10 rounded-3xl font-bold border border-emerald-800">
    </div>
  </div>
</div>
{{ room_name|json_script:"room-name" }}
{{ user.username|json_script:"user" }}
<script>
  const roomName = JSON.parse(document.getElementById('room-name').textContent);
  const user = JSON.parse(document.getElementById('user').textContent);
  const editablediv = document.querySelector('#chat-log');
  editablediv.scrollTop = editablediv.scrollHeight;

  const chatSocket = new WebSocket(
    'ws://'
    + window.location.host
    + '/ws/chat/'
    + roomName
    + '/'
  );

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const editablediv = document.querySelector('#chat-log');
    editablediv.innerHTML += `<span class="text-emerald-400">${data.message_sender}: </span> ${data.message}</br>`
    editablediv.scrollTop = editablediv.scrollHeight;
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
    if (e.key === 'Enter') {
      document.querySelector('#chat-message-submit').click();
    }
  };

  document.querySelector('#chat-message-submit').onclick = function(e) {
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value;
    if (message == ''){
      alert('A mensagem n√£o pode estar vazia')
    } else {
      chatSocket.send(JSON.stringify({
          'message': message
      }));
      messageInputDom.value = '';
    }
  };
</script>

{% endblock content %}
  